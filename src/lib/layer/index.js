"use strict";import "../drag/index.js";importCss("/css/layer-normal.css");Anot.ui.layer="1.0.0-normal";const log=console.log,LANGUAGES={en:{TITLE:"Dialog",YES_BTN:"OK",NO_BTN:"Cancel",ERROR:"The layer instance is not exists",NEED_CONTAINER:'layer "tips" require a DOM object as container'},zh:{TITLE:"提示",YES_BTN:"确定",NO_BTN:"取消",ERROR:"要关闭的layer实例不存在",NEED_CONTAINER:"tips类型需要指定一个元素节点作为容器"},"zh-TW":{TITLE:"提示",YES_BTN:"確定",NO_BTN:"取消",ERROR:"要關閉的layer實例不存在",NEED_CONTAINER:"tips类型需要指定一個元素節點作爲容器"}};LANGUAGES["zh-CN"]=LANGUAGES.zh;const lang=LANGUAGES[window.__ENV_LANG__||navigator.language]||LANGUAGES.en;let layerDom={},layerObj={},unique=null,lid=0,defconf={type:1,background:"#fff",mask:!0,maskClose:!1,maskColor:null,radius:"0px",area:["auto","auto"],title:lang.TITLE,menubar:!0,content:"",fixed:!1,shift:{},offset:{},btns:[lang.YES_BTN,lang.NO_BTN]};const $doc=Anot(document),uuid=function(){return"layer-"+lid++},close=function(e){if("string"!=typeof e&&"number"!=typeof e)return Anot.error(lang.ERROR);if(/^layerwrap\-/.test(e)||layerObj["layerwrap-"+e])try{if(e=(layerObj["layerwrap-"+e]?"layerwrap-":"")+e,!layerObj[e].show)return;layerObj[e].parentElem.replaceChild(layerObj[e].wrap,layerDom[e][0]),layerObj[e].wrap.style.display="none",layerObj[e].show=!1}catch(e){}else{unique=null;try{layerDom[e][0].classList.add("shift"),layerDom[e][1].classList.add("shift"),layerDom[e][0].style.opacity="",layerDom[e][1].style.opacity=0,setTimeout(function(){layerDom[e][0].parentNode.removeChild(layerDom[e][0]),delete layerDom[e],delete Anot.vmodels[e]},200)}catch(e){}}document.body.style.overflow=""},fixOffset=function(e){for(let t in e)"auto"===e[t]||!e[t]&&0!==e[t]?delete e[t]:isFinite(e[t])&&(e[t]+="px");return e};class __layer__{get dot(){return{1:1,2:5,3:5,4:9}}constructor(e){if(e){let{yes:t,no:o,success:s}=e;delete e.yes,delete e.no,delete e.success,this.__init__({state:{...e},props:{yes:t,no:o,success:s}}).append().show()}this.timeout=null}__init__(e){let t=e.$id||uuid();return this.init={$id:t,state:{...defconf,...e.state},props:e.props,skip:["area","shift","offset","mask","maskClose","container","follow"],methods:{shake(){this.$refs.layer.classList.add("scale"),setTimeout(()=>{this.$refs.layer.classList.remove("scale")},100)},onMaskClick:function(){this.type<4&&!this.maskClose?this.shake():this.maskClose&&this.close()},handleConfirm:function(){if(3===this.type&&!this.prompt)return this.shake();if("function"==typeof this.props.yes){let e=[this.$id];3===this.type&&e.unshift(this.prompt),this.props.yes.apply(this,e)}else this.close()},handleCancel:function(){"function"==typeof this.props.no?this.props.no.call(this,this.$id):this.close()},close:function(){close(this.$id)},cancelBubble:function(e){e.cancelBubble=!0}},mounted:function(){"function"==typeof this.props.success&&this.props.success.call(this)}},4===this.init.state.type&&(this.init.methods.autoSize=function(){let{layer:e,frame:t}=this.$refs;t.onload=function(){try{let o=t.contentWindow.document.body,{clientWidth:s,clientHeight:n}=o;e.style.cssText+=`width: ${s}px;height: ${n}px;`,t.style.cssText+=`height: ${n}px;`}catch(e){}}}),this}create(){let{state:e,$id:t}=this.init,o=document.createElement("div"),s=document.createElement("div");if(o.setAttribute("anot",t),o.setAttribute(":click","onMaskClick"),o.classList.add("do-layer"),e.mask&&(o.classList.add("mask"),e.container&&e.container!==document.body&&o.classList.add("inner")),e.maskColor&&(o.style.background=e.maskColor),s.classList.add("layer-box"),s.classList.add("skin-normal"),e.extraClass&&(s.classList.add(e.extraClass),delete e.extraClass),e.shift){fixOffset(e.shift);for(let t in e.shift){let o=e.shift[t];o+=isFinite(o)?"px":"",s.style.cssText+=`${t}: ${o};`}}e.toast?s.classList.add("type-toast"):s.classList.add("type-"+e.type),s.setAttribute("ref","layer"),s.setAttribute(":click","cancelBubble"),s.style.cssText+="border-radius:"+e.radius+"px",e.menubar||e.fixed||(s.setAttribute(":drag",""),s.setAttribute("data-limit","window"));var n="";"auto"!==e.area[0]&&(n+="width: "+e.area[0]+";"),"auto"!==e.area[1]&&(n+="height: "+e.area[1]+";");let i="";return 5===e.type&&(i+='<i class="arrow"></i>'),s.innerHTML=`\n      ${this.mkMenubar()}\n      <div\n        class="layer-content do-fn-cl"\n        style="${n}"\n        ${e.wrap||6===e.type?"":':html="content"'}>\n\n        ${6===e.type?this.mkLoading(e.load):""}\n      </div>\n      ${this.mkCtrl()}\n      ${i}\n    `,delete e.wrap,o.appendChild(s),[o,s]}mkLoading(e){return`\n      <div class="loading style-${e}">\n        <span class="dot-box">\n        ${(1===e?'<i class="do-icon-loading"></i>':"<i></i>").repeat(this.dot[e])}\n        </span>\n      </div>\n    `}mkMenubar(){let{menubar:e,fixed:t}=this.init.state,o="";return e&&(o=`\n        <div class="layer-title do-fn-noselect"\n          :text="title"\n          ${t?"":':drag="layer-box" data-limit="window"'}>\n        </div>\n      `),o}mkCtrl(){let{type:e}=this.init.state;if(e>3)return"";{let t="",o='\n        <a class="action-yes"\n          :click="handleConfirm"\n          tabindex="-1"\n          :text="btns[0]"\n          ></a>\n        ';return e>1&&(o='\n        <a class="action-no"\n          :click="handleCancel"\n          :text="btns[1]"\n          ></a>\n        '+o),t=`\n        <div class="layer-ctrl do-fn-noselect">\n          ${o}\n        </div>\n      `}}append(){let{state:e,$id:t}=this.init,o=e.container;return e.type<4&&(unique&&close(unique),unique=t),layerDom[t]=this.create(),delete e.toast,this.toast=!0,o||(o=document.body),o.appendChild(layerDom[t][0]),this.vm=Anot(this.init),this}show(){let{state:e,$id:t}=this.init,o=(this.vm,e.container);setTimeout(function(){let s={background:e.background},n=Anot(layerDom[t][1]);if(5===e.type){let i=getComputedStyle(layerDom[t][1]);s.color=e.color,s.opacity=1;let a=Anot(o),r=a[0].querySelector(".arrow"),l=a.innerWidth(),c=a.innerHeight(),d=a.offset().left-$doc.scrollLeft(),p=a.offset().top-$doc.scrollTop(),y=parseInt(i.width),f=parseInt(i.height),u=["top"];Anot(layerDom[t][1]).css(s),a.bind("mouseenter",t=>{let o={visibility:"visible"};d=a.offset().left-$doc.scrollLeft(),(p=a.offset().top-$doc.scrollTop())+18<f?(u[0]="bottom",r.style.borderBottomColor=e.background,o.top=p+c+8):(r.style.borderTopColor=e.background,o.top=p-f-8),d+.7*l+y>window.innerWidth?(o.left=d+.3*l-y,u[1]="left"):o.left=d+.7*l,r.classList.add("offset-"+u.join("-")),n.css(o)}),a.bind("mouseleave",()=>{setTimeout(()=>{r.classList.remove("offset-"+u.join("-")),u=["top"],r.style.borderBottomColor="",r.style.borderTopColor="",layerDom[t][1].style.visibility="hidden"},100)})}else{let o={opacity:1};e.offset&&(fixOffset(e.offset),Object.assign(o,e.offset)),n.css(s),setTimeout(()=>{document.body.style.overflow="hidden",layerDom[t][1].classList.add("shift"),setTimeout(e=>{n.css(o),setTimeout(e=>{try{layerDom[t][1].classList.remove("shift")}catch(e){}},500)},50)},50)}},4),e.type>3&&(e.timeout>0?(clearTimeout(this.timeout),this.timeout=setTimeout(()=>{clearTimeout(this.timeout),close(t),6===e.type&&this.vm.props.yes.call(this.vm,t)},e.timeout)):6===e.type&&this.vm.props.yes.call(this.vm,t))}}const _layer={alert(e,t,o){let s={content:e,fixed:!0};return"function"==typeof t?s.yes=t:(t&&(s.title=t+""),o&&"function"==typeof o&&(s.yes=o)),_layer.open(s)},confirm(e,t,o,s){let n={content:e,fixed:!0,type:2};return"function"==typeof t?(n.yes=t,"function"==typeof o&&(n.no=o)):(t&&(n.title=t+""),o&&"function"==typeof o&&(n.yes=o),s&&"function"==typeof s&&(n.no=s)),_layer.open(n)},frame(e,t={}){let o={content:`<iframe ref="frame" class="frame-box" src="${e}"></iframe>`,menubar:!1,maskClose:!0,type:4,...t};return _layer.open(o)},toast(e,t="info",o=2500){switch("number"==typeof t&&(o=t,t="info"),t){case"info":case"warn":break;case"error":t="deny";break;default:t="info"}let s={content:`\n      <mark class="toast-box style-${t}">\n        <i class="do-icon-${t}"></i>\n        ${e}\n      </mark>`,menubar:!1,mask:!1,type:7,shift:{top:0},timeout:o,offset:{top:50},fixed:!0,toast:!0};return _layer.open(s)},load:(e,t,o)=>(e=(e>>>=0)<1?1:e>4?4:e,"function"==typeof t?(o=t,t=null):(t instanceof HTMLElement||(t=null),"function"!=typeof o&&(o=Anot.noop)),_layer.open({container:t,type:6,load:e,yes:o,menubar:!1,background:"none",fixed:!0})),tips:(e,t,o={})=>t instanceof HTMLElement?(o.background||(o.background="rgba(0,0,0,.5)"),o.color||(o.color="#fff"),Object.assign(o,{container:t,content:e,type:5,fixed:!0,mask:!1,menubar:!1,timeout:0}),_layer.open(o)):Anot.error(lang.NEED_CONTAINER),prompt(e,t){if("function"!=typeof t)return console.error("argument [callback] requires a function, but "+typeof t+" given");let o={type:3,prompt:"",title:e,content:'<input class="prompt-value" data-duplex-focus :class="{alert: !prompt}" :duplex="prompt" />',fixed:!0,yes:t};return _layer.open(o)},close:close,open(e){if("string"==typeof e){if(layerObj[e="layerwrap-"+e])return layerObj[e].show?e:(layerObj[e].show=!0,layerObj[e].parentElem.appendChild(layerDom[e][0]),layerDom[e][0].querySelector(".layer-content").appendChild(layerObj[e].wrap),layerObj[e].wrap.style.display="",Anot.vmodels[e]||Anot(layerObj[e].obj.init),layerObj[e].obj.show(),e);throw new Error(lang.ERROR)}return new __layer__(e).init.$id},version:Anot.ui.layer};Anot.directive("layer",{priority:8090,init:function(e){e.element.removeAttribute(e.name),e.param&&"tips"===e.param||(e.param="",e.element.style.display="none")},update:function(e){if(!e)return console.error(`SyntaxError: Unexpected [${this.name}=${this.expr}]`);let t=Object.assign({type:7,wrap:!0},this.element.dataset);if(this.param){if("tips"===this.param){let o=document.createElement("div"),s=document.createElement("span"),n=document.createElement("i"),i=Anot(this.element),{position:a}=getComputedStyle(this.element);o.className="do-layer__tips",s.className="layer-content",n.className="arrow",s.textContent=e,o.appendChild(s),o.appendChild(n),"static"===a&&(this.element.style.position="relative"),this.element.appendChild(o);let r={};t.color&&(r.color=t.color),t.color&&(r.background=t.background);let l=i.innerWidth(),c=i.innerHeight(),d=["top"];Anot(o).css(r),i.bind("mouseenter",e=>{let s={visibility:"visible"},a=o.clientWidth,r=o.clientHeight,{left:p,top:y}=i.offset(),f=p-$doc.scrollLeft();y-$doc.scrollTop()<r+8?(d[0]="bottom",n.style.borderBottomColor=t.background,s.bottom="",s.top=c+8):(n.style.borderTopColor=t.background,s.top="",s.bottom=c+8),f+.7*l+a>window.innerWidth?(s.left=.3*l-a,d[1]="left"):s.left=.7*l,n.classList.add("offset-"+d.join("-")),Anot(o).css(s)}),i.bind("mouseleave",()=>{setTimeout(()=>{n.classList.remove("offset-"+d.join("-")),d=["top"],n.style.borderBottomColor="",n.style.borderTopColor="",o.style.visibility="hidden"},100)})}}else{let o={$id:"layerwrap-"+e,state:t,props:{}};t.hasOwnProperty("area")&&(t.area=t.area.split(",")),t.hasOwnProperty("shift")&&(t.shift=fixOffset(new Function(`return ${t.shift}`)())),t.hasOwnProperty("offset")&&(t.offset=fixOffset(new Function(`return ${t.offset}`)())),t.hasOwnProperty("btns")&&(t.btns=t.btns.split(",")),t.hasOwnProperty("menubar")||(t.menubar=!1);let s=(new __layer__).__init__(o);for(let e in this.element.dataset)delete this.element.dataset[e];layerObj[s.init.$id]={obj:s,parentElem:this.element.parentNode,wrap:this.element,show:!1},layerDom[s.init.$id]=s.create()}}}),window.layer=_layer;export default _layer;