/**
 *
 * @authors yutent (yutent@doui.cc)
 * @date    2019-09-01 23:16:06
 * @version v2.0.1
 * 
 */

'use strict'

import"../form/input.js";import Drag from"../drag/core.js";import{nextTick,bind,unbind,clickOutside}from"../utils.js";const LANGUAGES={en:{TITLE:"Dialog",BTNS:["Cancel","OK"],ERROR:"The layer instance is not exists"},zh:{TITLE:"提示",BTNS:["取消","确定"],ERROR:"要关闭的layer实例不存在"}};LANGUAGES["zh-CN"]=LANGUAGES.zh;const lang=LANGUAGES[window.__ENV_LANG__||navigator.language]||LANGUAGES.en;let unique=null,defconf={type:1,background:"#fff",mask:!0,maskClose:!1,maskColor:null,radius:"0px",area:["auto","auto"],title:lang.TITLE,menubar:!0,content:"",fixed:!1,shift:{},offset:{}};const UNIQUE_TYPES=["alert","confirm","prompt"],fixOffset=function(e){for(let t in e)"auto"===e[t]||!e[t]&&0!==e[t]?delete e[t]:isFinite(e[t])&&(e[t]+="px");return e};function createLayer(e){var t=document.createElement("wc-layer");return e.mask&&t.setAttribute("mask",""),t.title=e.title,e.btns&&e.btns.length?t.props.btns=e.btns:t.props.btns=lang.BTNS.concat(),e.intercept&&"function"==typeof e.intercept&&(t.props.intercept=e.intercept),t.props.background=e.background,t.props.mask=e.mask,t.props.maskClose=e.maskClose,t.props.maskColor=e.maskColor,t.type=e.type,t.innerHTML=e.content,document.body.appendChild(t),UNIQUE_TYPES.includes(e.type)&&(unique&&unique.close(),unique=t),t.promise}const _layer={alert:(e,t=lang.TITLE)=>createLayer({type:"alert",title:t,content:e,fixed:!0,mask:!0}),confirm:(e,t=lang.TITLE,r)=>("function"==typeof t&&(r=t,t=lang.TITLE),createLayer({type:"confirm",title:t,content:e,fixed:!0,mask:!0,intercept:r})),prompt:(e=lang.TITLE,t)=>createLayer({type:"prompt",title:e,content:'<wc-input autofocus class="layer__content__input"></wc-input>',fixed:!0,mask:!0,intercept:t}),frame:(e,t={})=>createLayer({...t,type:"frame",content:`<iframe class="layer__content__frame" src="${e}"></iframe>`,fixed:!0,mask:!0,maskClose:!0}),toast(e,t="info",r=2500){switch("number"==typeof t&&(r=t,t="info"),t){case"info":case"warn":break;case"error":t="deny";break;default:t="info"}let i={content:`\n      <mark class="toast-box style-${t}">\n        <i class="do-icon-${t}"></i>\n        ${e}\n      </mark>`,menubar:!1,mask:!1,type:7,shift:{top:0},timeout:r,offset:{top:50},fixed:!0,toast:!0};return _layer.open(i)},open(e){if("string"==typeof e){if(e="layerwrap-"+e,layerObj[e])return layerObj[e].show?e:(layerObj[e].show=!0,layerObj[e].parentElem.appendChild(layerDom[e][0]),layerDom[e][0].querySelector(".layer-content").appendChild(layerObj[e].wrap),layerObj[e].wrap.style.display="",Anot.vmodels[e]||Anot(layerObj[e].obj.init),layerObj[e].obj.show(),e);throw new Error(lang.ERROR)}return new __layer__(e).init.$id}};function renderBtns(e){var t="";return e.forEach((e,r)=>{t+=`<button data-idx="${r}"">${e||lang.BTNS[r]}</button>`}),t}class Layer extends HTMLElement{static get observedAttributes(){return["btns","type","title","fixed"]}constructor(){super(),Object.defineProperty(this,"root",{value:this.attachShadow({mode:"open"}),writable:!0,enumerable:!1,configurable:!0}),Object.defineProperty(this,"props",{value:{btns:[],type:"msg",title:"",fixed:!1},writable:!0,enumerable:!1,configurable:!0}),this.root.innerHTML="<style>*{box-sizing:border-box;margin:0;padding:0}::before,::after{box-sizing:border-box}:host{display:flex;justify-content:center;align-items:center;width:auto;height:auto}.noselect{-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.noselect img,.noselect a{-webkit-user-drag:none}.layer{flex:0 auto;position:absolute;z-index:65535;border-radius:3px;color:#666;font-size:14px;box-shadow:0 5px 20px rgba(0,0,0,0.3)}.layer.shift{transition:all 0.5s ease-out}.layer.scale{transform:scale(1.01);transition:transform 0.1s linear}.layer.blur{backdrop-filter:blur(5px)}.layer:active{z-index:65536}.layer__title{display:flex;width:100%;height:60px;padding:15px;line-height:30px;font-size:16px;color:#526273}.layer__content{display:flex;position:relative;width:100%;height:auto;min-height:50px;word-break:break-all;word-wrap:break-word}::slotted(.layer__content__input){flex:1;height:32px}::slotted(.layer__content__frame){display:flex;width:100%;height:100%;margin:0;padding:0;border:0;resize:none}.layer__ctrl{display:flex;justify-content:flex-end;width:100%;height:60px;padding:15px;line-height:30px;font-size:14px;color:#454545;text-align:right}.layer__ctrl button{min-width:64px;height:30px;padding:0 10px;margin:0 5px;border:1px solid #dae1e9;border-radius:4px;white-space:nowrap;background:#fff;font-size:inherit;outline:none;color:inherit}.layer__ctrl button:hover{background:#f3f5fb}.layer__ctrl button:active{border-color:#aabac3}.layer__ctrl button:last-child{color:#fff;background:#19b491;border-color:transparent}.layer__ctrl button:last-child:hover{background:#3fc2a7}.layer__ctrl button:last-child:active{background:#16967a}.layer__ctrl button::-moz-focus-inner{border:none}:host([mask]){position:fixed;z-index:65534;left:0;top:0;width:100%;height:100%;background:rgba(255,255,255,0.15);backdrop-filter:blur(5px)}:host([mask]).shift{transition:all 0.5s ease-out}:host([mask]).inner{position:absolute}:host([type='alert']) .layer,:host([type='confirm']) .layer,:host([type='prompt']) .layer{max-width:600px;min-width:300px;background:#fff}:host([type='alert']) .layer__content,:host([type='confirm']) .layer__content,:host([type='prompt']) .layer__content{padding:0 15px}\n</style> <div class=\"layer\"> <div class=\"layer__title noselect\"></div> <div class=\"layer__content\"><slot></slot></div> <div class=\"layer__ctrl noselect\"></div> </div> ",this.__TITLE__=this.root.children[1].firstElementChild,this.__BODY__=this.root.children[1].children[1],this.__CTRL__=this.root.children[1].lastElementChild,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}set title(e){e?(this.__TITLE__.textContent=e,this.__TITLE__.style.display=""):this.__TITLE__.style.display="none"}set type(e){var{btns:t}=this.props;switch(e){case"alert":for(;t.length>1;)t.splice(0,1);break;case"confirm":case"prompt":for(;t.length>2;)t.splice(0,1);break;case"toast":case"frame":t=[];break;default:e="common"}this.props.type=e,t.length?(this.__CTRL__.innerHTML=renderBtns(t),this.__CTRL__.style.display=""):this.__CTRL__.style.display="none",this.setAttribute("type",e)}set fixed(e){this.props.fixed=!!e,UNIQUE_TYPES.includes(this.props.type)||(this.props.fixed?this._dragIns&&(this._dragIns.destroy(),this._dragIns=null):(this._dragIns=new Drag(this.root.children[1]).by(this.__TITLE__,{overflow:!1}),this.removeAttribute("fixed")))}_intercept(e){this.props.intercept?this.props.intercept(e,t=>{delete this.props.intercept,this.resolve(e),this.close()}):(this.resolve(e),this.close())}close(){this._dragIns&&this._dragIns.destroy(),UNIQUE_TYPES.includes(this.props.type)&&(unique=null),delete this.promise,unbind(this.__CTRL__,"click",this._handleBtnClick),this.parentNode.removeChild(this)}connectedCallback(){this._handleBtnClick=bind(this.__CTRL__,"click",e=>{if("BUTTON"===e.target.tagName){var t=+e.target.dataset.idx,{intercept:r,type:i}=this.props;switch(i){case"alert":this.resolve(),this.close();break;case"confirm":case"prompt":if(0===t)this.reject(),this.close();else{let e="prompt"===i?this.__INPUT__.value:null;this._intercept(e)}break;default:this.resolve(t),this.close()}}}),"prompt"===this.props.type&&(this.__INPUT__=this.__BODY__.firstElementChild.assignedNodes().pop(),this._handleSubmit=bind(this.__INPUT__,"submit",e=>{this._intercept(e.detail)})),this.props.mask&&(this._handlMask=clickOutside(this.root.children[1],e=>{this.props.maskClose?this.close():UNIQUE_TYPES.includes(this.props.type)&&(this.root.children[1].classList.toggle("scale",!0),setTimeout(e=>{this.root.children[1].classList.remove("scale")},100))}))}disconnectedCallback(){unbind(document,"mousedown",this._handlMask)}attributeChangedCallback(e,t,r){if(t!==r)switch(e){case"title":case"type":this[e]=r;break;case"fixed":this.fixed=!0}}}window.layer=_layer;export default _layer;

if(!customElements.get('wc-layer')){
  customElements.define('wc-layer', Layer)
}
